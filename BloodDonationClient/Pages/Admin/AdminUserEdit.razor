@page "/admin/users/edit/{UserId:int}"
@using BloodDonationClient.Models
@using BloodDonationClient.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject AdminService AdminService
@inject NavigationManager Navigation

<PageTitle>Admin - Edit User</PageTitle>

<AuthorizeView Roles="admin">
    <Authorized Context="authContext">
        <div class="container my-5">
            <h3 class="text-primary">Edit User Details</h3>

            @if (isLoading)
            {
                <p><em>Loading user details...</em></p>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            else if (user != null)
            {
                <EditForm Model="updateModel" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <!-- Username -->
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <InputText @bind-Value="updateModel.Username" id="username" class="form-control" />
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <InputText @bind-Value="updateModel.Email" id="email" type="email" class="form-control" />
                    </div>

                    <!-- Blood Type -->
                    <div class="form-group">
                        <label for="bloodType">Blood Type:</label>
                        <InputSelect @bind-Value="updateModel.BloodType" id="bloodType" class="form-control">
                            <option value="">-- Select Blood Type --</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </InputSelect>
                    </div>

                    <!-- Date of Birth -->
                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth:</label>
                        <InputDate @bind-Value="updateModel.DateOfBirth" id="dateOfBirth" class="form-control" />
                    </div>

                    <!-- Gender -->
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <InputSelect @bind-Value="updateModel.Gender" id="gender" class="form-control">
                            <option value="">-- Select Gender --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </InputSelect>
                    </div>

                    <!-- Phone Number -->
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number:</label>
                        <InputText @bind-Value="updateModel.PhoneNumber" id="phoneNumber" type="tel" class="form-control" />
                    </div>

                    <!-- Address -->
                    <div class="form-group">
                        <label for="address">Address:</label>
                        <InputText @bind-Value="updateModel.Address" id="address" class="form-control" />
                    </div>

                    <!-- Role -->
                    <div class="form-group">
                        <label for="role">Role:</label>
                        <InputSelect @bind-Value="updateModel.Role" id="role" class="form-control">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </InputSelect>
                    </div>

                    <!-- New Password -->
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <InputText @bind-Value="updateModel.NewPassword" id="newPassword" type="password" class="form-control" />
                    </div>

                    <!-- Submit and Cancel Buttons -->
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                        <button type="button" class="btn btn-secondary ml-2" @onclick="Cancel">Cancel</button>
                    </div>
                </EditForm>

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success mt-3">@successMessage</div>
                }

                @if (!string.IsNullOrEmpty(updateErrorMessage))
                {
                    <div class="alert alert-danger mt-3">@updateErrorMessage</div>
                }
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container my-5">
            <h3 class="text-danger">Access Denied</h3>
            <p>You do not have permission to view this page.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public int UserId { get; set; }

    private AdminUserDto user;
    private UpdateUserDto updateModel = new UpdateUserDto();
    private bool isLoading = true;
    private string errorMessage;
    private string successMessage;
    private string updateErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserDetails();
    }

    private async Task LoadUserDetails()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            user = await AdminService.GetUserByIdAsync(UserId);
            // Initialize updateModel with current user data
            updateModel = new UpdateUserDto
                {
                    Username = user.Username,
                    Email = user.Email,
                    BloodType = user.BloodType,
                    DateOfBirth = user.DateOfBirth,
                    Gender = user.Gender,
                    PhoneNumber = user.PhoneNumber,
                    Address = user.Address,
                    Role = user.Role
                    // NewPassword is left null by default
                };
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred while loading user details.";
            // Optionally log the exception
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        updateErrorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var success = await AdminService.UpdateUserAsync(UserId, updateModel);
            if (success)
            {
                successMessage = "User updated successfully.";
                // Optionally, reload user details
                await LoadUserDetails();
            }
            else
            {
                updateErrorMessage = "Failed to update the user.";
            }
        }
        catch (Exception ex)
        {
            updateErrorMessage = "An error occurred while updating the user.";
            // Optionally log the exception
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/admin/users/{UserId}");
    }
}
